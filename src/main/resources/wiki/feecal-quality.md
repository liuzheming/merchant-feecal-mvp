# feeCal 质量保障方案

> 适用范围：`commerce-merchant-config-feecal` 及其依赖的 API、DAO、事件、配置模块，涵盖资金配置、计费引擎、费率模板、结算协同等全链路。所有资金与费用相关能力统一按本文标准执行。

## 目标与约束
- **资金准确性**：任何资金变动都必须可追踪、可回溯，账实相符。
- **资金安全性**：杜绝越权调用、数据泄露、非法篡改，将权限最小化。
- **业务连续性**：升级、扩容、异常恢复过程不得影响资金流水完整性。

## 核心风险面
1. **流程设计缺陷**：状态机遗漏、并发条件竞争、补偿策略缺失导致资金错记。
2. **数据质量问题**：账务字段类型、精度配置不当，或跨模块传输被截断/转换错误。
3. **上线回滚能力不足**：配置热更新/降级策略缺失，引发资金阻塞或重复扣款。
4. **监控告警滞后**：关键指标缺失，导致异常到账户损失后才被发现。
5. **权限与审计薄弱**：资金配置被非授权人员修改，或缺乏操作留痕。

## 质量保障行动

### 设计与开发阶段
- **资金需求评审**：将财务、风控、测试、运维纳入评审，明确入账出账场景、币种、汇率、税费规则。
- **状态机与幂等策略**：为每条资金流水定义唯一业务 id，确保重试/补单可识别；关键接口自带去重表或 token。
- **数据契约与校验**：在 `model/` 中为金额类字段统一使用 `BigDecimal`，并通过 Bean Validation + 自定义校验器限制精度、非负性。
- **双重记账/对账钩子**：在 `commerce-merchant-config-feecal` 和 `commerce-merchant-config-dao` 中增加对账事件，写入内部对账表供离线核对。
- **安全基线**：所有资金配置接口必须启用签名/鉴权、中台授权校验，并记录操作审计日志（操作者、时间、变更内容）。

### 测试策略
- **单元覆盖**：对金额计算、舍入策略、阈值判断编写边界类单测，并强制 Jacoco 覆盖率不低于 80%。
- **契约与集成测试**：使用 `spring-restdocs` 或类似工具生成资金接口契约，自动校验字段含义、精度、缺省值。
- **回归资金回路**：设计 end-to-end 资金路径测试（下单→扣费→结算→对账），并固化到 `run.sh dev` 可执行脚本。
- **混沌与容灾演练**：注入 DB 延迟/失败、上游幂等 key 冲突等场景，验证补偿流程；演练跨机房切换期间的对账一致性。


### 可观测与告警
- **指标体系**：输出成功率、延迟、资金不平账数、手工补单数、重试次数等指标到 Prometheus；关键指标设 hard alert。
- **日志追踪**：统一 traceId，资金流水日志至少包含业务 id、原始请求、计算结果、风控决策；敏感字段加密脱敏。
- **自动对账**：每小时触发线上对账任务（数据库 + 外部账单），若差异>阈值立即报警并冻结相关功能。

### 运营与应急
- **日常稽核**：建立资金日报、周报，自动生成差异列表交由财务复核。
- **应急预案**：预先定义“重复扣款”“漏记入账”“对账延迟”等事故剧本，包含定位步骤、补救动作、沟通渠道。
- **知识沉淀**：重大事故复盘输出到 `solution-docs`，定期培训开发/测试/运维对资金质量要求。

## 下一步建议
1. 梳理现有资金流程图与状态机，补齐文档与审计表。
2. 盘点已有测试/监控覆盖情况，补充缺口清单并排期。
3. 与财务、风控共建对账指标和告警阈值，打通数据面板与响应机制。

## 严肃执行计划（行动+理由）
1. **成立资金质量专项小组（负责人+财务/风控/测试/运维参与）**：确保所有决策有跨职能视角，避免单模块优化带来系统性风险。
2. **Week 1：资产盘点与基线评估**
   - 行动：梳理所有资金相关服务、配置、数据库表、对外依赖；提炼关键交易路径。
   - 理由：没有清晰资产清单无法界定风险范围，基线评估是后续改进的对照。
3. **Week 2：风险与缺口评审**
   - 行动：依据盘点成果，对照“核心风险面”逐项评估，形成红黄绿矩阵和优先级。
   - 理由：保证资源投向最高风险点，资金系统必须先止血后优化。
4. **Week 3-4：控制面建设**
   - 行动：补齐状态机/幂等、审计日志、灰度开关等硬性控制；同步完善安全与权限策略。
   - 理由：控制面是阻断事件发生的第一道防线，必须在进入大规模测试前就位。
5. **Week 5：质量与回归体系**
   - 行动：完善单元/集成/回归/混沌测试脚本，纳入 CI；定义必须通过的门禁项（覆盖率、契约校验）。
   - 理由：资金需求迭代快，自动化测试是防止回归的唯一可扩展手段。
6. **Week 6：可观测 & 告警落地**
   - 行动：上线指标、日志、链路追踪与自动对账任务；配置报警策略并跑一次演练。
   - 理由：没有实时可观测和演练的告警，发现问题永远滞后于损失。
7. **Week 7：演练与应急**
   - 行动：执行跨机房演练、重复扣款/漏记等事故脚本，打通沟通链路与指挥棒。
   - 理由：资金事故处理窗口按分钟计算，演练能够验证流程、磨合团队协作。
8. **Week 8：审计与固化**
   - 行动：将流程、指标、操作手册沉淀到 `wiki` / `solution-docs`，并设定季度复盘机制。
   - 理由：资金质量是一项持续性工作，制度化和审计才能让改进可持续。

## 系统现状评估
- **做得不错的地方**：Controller→Facade→Service 分层清晰，批次操作自带 Redisson 分布式锁 + Spring 事务；账单分配服务会校验“分配合计=抵扣金额”，资金指令执行会回写状态，便于追溯。
- **关键短板**
  - 过度信任前端入参：`saveDraft/submit` 直接以请求金额更新批次/termInst，缺少服务端独立计算和双重记账/对账。
  - 资金指令不可再生成：`FundInstructionGenerator` 只要发现已有指令就返回，无法覆盖调整抵扣或回滚场景。
  - 自动化测试缺位：feecal 模块没有单测/契约/混沌/E2E 测试，Jacoco 门禁无法执行。
  - 可观测、审计、权限薄弱：核心路径缺少结构化日志、指标、traceId，也没有最小权限与操作留痕。
  - 发布/止损手段不足：目前只有状态机拦截重复提交，没有灰度开关、止损阈值和快速回滚脚本。

## 常见质量/资金安全话题（现状 + 改进）

1. **feeCal 如何保证资金计算准确？有双校验/对账吗？**  
   - 回答：我们现在的流程是：只要客户点开批次，后台就会强制去校验账单快照是否 READY，拉一遍 termInst 和账单分配，然后在服务端重新算抵扣金额、保证金余额，像“抵扣额不能大于欠费”“保证金不能为负”这些硬规则都在 `FeeCalSummaryService#doCalculate` 里做了。账单分配服务会再核对“分配合计=抵扣金额”，避免账单维度出错。  
   - 接下来要做的是把“请求金额”彻底降级成提示值：我们会基于 billing snapshot 聚合出系统权威金额，和前端入参比对后写入双份记录（系统算的 + 操作人录的），并把每条资金指令推到对账任务里，每小时和账务系统自动对平，还会连通 Prometheus 做差异报警。
2. **回滚或配置出错时，如何避免重复扣费/漏记？**  
   - 回答：就算现在是 MVP，批次操作也被 Redisson 锁 + 状态机夹住了：同一个 batchNo 除非结束，否则不会被重复提交，资金指令也必须人工点执行。我们还设计了“资金指令生成”和“执行”分离，批次一旦需要回退可以先停在 PENDING。  
   - 不过为了做到真正的“安全闸”，我们正在补三个动作：① 配置灰度/止损开关，允许按商户、区域关闭新规则；② 批次复制/撤销功能，让错误配置能一键回滚；③ 资金指令重建和补偿脚本，保证改完配置后可以重算、重下指令，避免人工删库。
3. **规则频繁变更，如何验证不破坏旧流水？**  
   - 回答：架构上我们把核心逻辑集中在 `FeeCalCoreServiceImpl` 和 `FeeCalSummaryService`，所以目前能快速 mock 账单快照，重放“生成→计算→提交”流程，MVP 阶段我们是靠脚本跑了一条 happy path 来验证。  
   - 下一步会把这条链路产品化：加单元+契约+E2E 三层测试，CI 每次合入都跑通“批次→提交→资金指令”全链路；灰度期用影子流量或暗发布把新旧结果并排对比，真正做到“规则多变但心里有数”。
4. **有哪些实时指标/报警来判断 feeCal 健康？**  
   - 回答：目前我们已经能在日志里拿到批次号、termCode、操作人，排查时不会丢上下文；资金指令执行完也会把状态落库，用来统计成功/失败率。  
   - 但日志不是指标，所以我们在做两件事：① 在 Controller 和资金指令执行器里埋 Prometheus 指标（请求成功率、P99、锁失败量、指令执行率、对账差异、手工补单数）；② 设 hard alert + 止损阈值，触发后自动冻结可疑批次，同时推送到 on-call。
5. **跨机房故障或上游超时时，如何确保幂等和一致性？**  
   - 回答：批次层面我们用 Redisson key 做了互斥，且所有写操作都是事务包裹，最坏情况是抛错回滚，不会出现半条记录。这保证了“单批次内”的一致性。  
   - 接下来我们会把幂等做细：每条资金指令都会挂一个 `instructionBizId`，传给 FundGateway 作为去重 key；重试策略写进状态机，配合混沌演练去模拟“跨机房切主/上游 500”等极端情况，验证状态机不会乱。
6. **权限和审计怎么做？谁能改费率，如何追踪？**  
   - 回答：MVP 阶段我们先把接口和操作人信息打通——Controller 接口都要求传 operator，后台全链路用 traceId+batchNo 记录，方便追查“谁改了什么”。  
   - 真正上线时，费率/资金配置都会挂在统一鉴权（中台/网关）下，只允许具备角色的人发起；所有敏感操作写审计表（操作者、旧值、新值、原因），并走双人审批。这样面试官会知道：即便 MVP 以架构亮点为主，我们已经把质量/安全兜底方案规划好了。
7. **如果对账发现差异或资金指令失败，如何止损和补救？**  
   - 回答：当前我们把资金指令生成/执行解耦，指令默认停在 PENDING，执行失败会落库 `FAIL`，同时记录操作人和原始响应，方便人工重试。批次状态也会保持在 DONE 之前，避免重复扣费。  
   - 下一步会按金额/商户维度给差异分级：超过阈值就自动冻结该批次、停止新指令，并把告警推给财务+风控；Runbook 里准备好了补偿脚本（重新生成指令、补扣/退款），处理完毕后才放行。同时会把差异事件写到审计表，方便追责。
8. **feeCal 怎么满足合规/稽核要求？监管来查时能交付什么？**  
   - 回答：MVP 阶段我们已经在日志/数据库里保留了关键字段——batchNo、termCode、操作人、原始请求、计算结果、资金指令状态，这些足够还原一次资金操作。  
   - 未来会把这些审计记录结构化，定期导出给财务/内控，并接入合规系统：一方面提供监管需要的报表（资金指令列表、差异处理记录），另一方面把敏感字段脱敏后存档 ≥N 年，确保任何审计都能迅速交付。
